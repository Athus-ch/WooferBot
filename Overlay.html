<!--
    WooferBot, an interactive BrowserSource Bot for twitch.tv
    Copyright (C) 2019  Tomaae
    (https://github.com/tomaae/WooferBot)

    This file is part of WooferBot.

    WooferBot is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    WooferBot is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with WooferBot.  If not, see <https://www.gnu.org/licenses/>.
-->
<html>
<style>
	
@import url("https://fonts.googleapis.com/css?family=Fira+Sans");
body { background-color: rgba(0, 0, 0, 0); margin: 0px auto; overflow: hidden;background: #c0c0c0; }

.mainbox {
	position: relative;
	height: 400px;
}

.mascot {
  position: absolute;
  bottom: 0;
  left: 0;
	width:150px;
}

.mascot img {
	display: block;
	margin-left: auto;
	margin-right: auto;
}

.message {
	position: absolute;
  bottom: 95px;
  left: 160px;
  min-width:300px;
  max-width:500px;
  min-height:70px;
  
  background-color: #fef7ed;
  border-width: 4px;
  border-style: solid;
  border-color: #ffba70;
  border-radius: 4px;
  box-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
  
  font-size: 22px;
  font-weight: 900;
  color: #b16a16;
  font-family: 'Fira Sans';
  
  word-wrap: break-word;
  word-break: keep-all;
}

.user {
	color: #ffba70;
	font-size: 24px;
	letter-spacing:3px;
	text-shadow: -1px -1px 0 #b16a16, 1px -1px 0 #b16a16,-1px 0 0 #b16a16, 1px 0 0 #b16a16,	-1px 1px 0 #b16a16,0 -1px 0 #b16a16, 0 1px 0 #b16a16, 1px 1px 0 #b16a16, 3px 3px 3px #ffba70;
}

.message::after {
	content: '';
	position: absolute;
	left: 0;
	bottom: 10px;
	width: 0;
	height: 0;
	border: 29px solid transparent;
	border-right-color: #fff;
	border-left: 0;
	border-bottom: 0;
	margin-top: -14.5px;
	margin-left: -29px;
	z-index: -1;
}

.message div:first-child {
	content: '';
	position: absolute;
	left: -26px;
	bottom: 11px;
	width: 0;
	height: 0;
	border: 23px solid transparent;
	border-right-color: #ffba70;
	border-left: 0;
	border-bottom: 0;
}

.image {
	margin: 7px;
	float: left;
	height: 75px;
	width: 75px;
	border-radius: 7px;
  border-width: 2px;
  border-style: solid;
  border-color: #ffba70;
	box-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
}

.msg {
	padding: 7px;
}
</style>

<body>
  <div>
		<p id="my_event"></p>
	</div>
</body>


<script>
	function modifyCSSProperty(selector, property, value){
		var sheets = document.styleSheets;
		var sheet, rules;
		var i, j, iLen, jLen;
		
		for(i=0, iLen=sheets.length; i<iLen; i++){
			sheet = sheets[i];
			if(sheet.cssRules){
				rules = sheet.cssRules;
				for(j=0, jLen=rules.length; j<jLen; j++){
					if(rules[j].selectorText == selector)rules[j].style.setProperty(property, value);
					console.log(rules[j].selectorText);
				}
			}
		}
	}
	
	
  var Overlay = {

  	//---------------------------------
  	// HTML Elements
  	//---------------------------------
  	myEvent: document.getElementById('my_event'),

  	Listen: function() {
  		this.socket = new WebSocket('ws://127.0.0.1:3338');
  		this.connected = false;

  		//---------------------------------
  		// Open Event
  		//---------------------------------
  		this.socket.onopen = function() {
  			this.connected = true;

  		}

  		//---------------------------------
  		// Error Event
  		//---------------------------------
  		this.socket.onerror = function(error) {
  			// Something went terribly wrong... Respond?!
  			console.log('Error: ' + error);
  		}

  		//---------------------------------
  		// Message Event
  		//---------------------------------
  		this.socket.onmessage = function(message) {
  			//console.log(message);
  			
        var json = JSON.parse(message.data);
        //console.log("json", json);
        
        if(json.styles !== undefined){
        	var style = Object.keys(json.styles);
        	for(var i=0, iLen=style.length; i<iLen; i++){
        		val = style[i].split("|");
        		modifyCSSProperty(val[0], val[1], json.styles[style[i]]);
        	}
        }
        
        if(json.event == 'EVENT_WOOFERBOT') {
          var data = JSON.parse(json.data);
          //console.log("data", data);

          htmlobj = `<div class="mainbox ${message.timeStamp}">`;
          if(data.message){
          	htmlobj += `<div class="message"><div></div>`;
          	if(data.image)htmlobj += `<img class="image" src="${data.image}"></img>`;
          	if(data.audio){
          		var audio = new Audio(data.audio);
           		audio.volume = data.volume;
          		audio.play();
          	}
          	
          	while(data.message.indexOf("[") >= 0){
          		tmp = data.message.substring(data.message.indexOf("["), data.message.indexOf("]") + 1);
          		tmp = tmp.replace(/^\s*\[\s*|\s*\]\s*$/g, "");
          		val = tmp.split(/\s*;\s*/);
          		data.message = data.message.substring(0, data.message.indexOf("[")) + val[Math.floor(Math.random() * val.length)] + data.message.substring(data.message.indexOf("]") + 1);
          	}

          	if(data.message.indexOf("{sender}")){
          		if(data.sender === undefined)data.sender = "";
          		data.message = data.message.replace(/{sender}/gi, '<span class="user">' + data.sender + '</span>');
          	}
          	if(data.message.indexOf("{recipient}")){
          		if(data.recipient === undefined)data.recipient = "";
          		data.message = data.message.replace(/{recipient}/gi, '<span class="user">' + data.recipient + '</span>');
          	}
          	if(data.message.indexOf("{bits}")){
          		if(data.bits === undefined)data.bits = "";
          		data.message = data.message.replace(/{bits}/gi, '<span class="user">' + data.bits + '</span>');
          	}
          	if(data.message.indexOf("{months}")){
          		if(data.months === undefined)data.months = "";
          		data.message = data.message.replace(/{months}/gi, '<span class="user">' + data.months + '</span>');
          	}
          	if(data.message.indexOf("{activity}")){
          		if(data.activity === undefined)data.activity = "";
          		data.message = data.message.replace(/{activity}/gi, '<span class="user">' + data.activity + '</span>');
          	}
          	
          	htmlobj += `<div class="msg">` + data.message + `</div>`;
          	htmlobj += `</div>`;
          }
          if (typeof data.id !== 'undefined'){
          	data.mascot += '?x=' + Date.now();
          }
          htmlobj += `<div class="mascot"><img src="${data.mascot}" id="mascot"></img></div>`;
        	htmlobj += `</div>`;
        	
        	// Modify mascot's mouth height
        	modifyCSSProperty(".message", "bottom", data.mascotmouth + "px");
        	
        	
        	// Update interface
        	Overlay.myEvent.innerHTML = htmlobj
        }
  			
  			// You have received new data now process it
  			//console.log(message);
  		}

  		//---------------------------------
  		// Close Event
  		//---------------------------------
  		this.socket.onclose = function() {
  			// Connection has been closed by you or the server
  			console.log('Connection Closed!');
  			this.connected = false;
  			setTimeout(Overlay.Listen, 3000)
  		}
  	}
  }

  // Start Script
  Overlay.Listen();
</script>

</html>